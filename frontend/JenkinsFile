pipeline {
    agent any

    environment {
        // =================================================================
        // [설정] 파일 경로 변수는 이제 필요 없습니다!
        // =================================================================
        PROJECT_DIR    = "frontend"

        // 프로젝트 및 AWS 환경 설정
        GIT_REPO       = "https://github.com/kgssks/fc-lab-petclinic.git"
        REGION         = "ap-northeast-2"

        // ECR 설정
        ECR_REPO_URI   = "471112978667.dkr.ecr.ap-northeast-2.amazonaws.com"
        ECR_NAME       = "fc-front"

        // ECS 설정
        ECS_CLUSTER    = "final-cluster"
        ECS_SERVICE    = "task-front-def-service"

        // [중요] AWS에 등록된 Task Definition의 패밀리 이름 (Family Name)
        // AWS 콘솔 > ECS > Task Definitions 에서 확인 가능
        ECS_TASK_FAMILY = "task-front-def"

        // 권한 설정
        AWS_CREDENTIALS = "aws-credentials-cicd"
        IAM_ROLE_ARN    = "arn:aws:iam::471112978667:role/ecr-upload-role"
    }

    stages {
        stage('Git Clone') {
            steps {
                cleanWs()
                git branch: 'main', url: "${GIT_REPO}"
            }
        }

        stage('Build & Push to ECR') {
            steps {
                script {
                    dir("${PROJECT_DIR}") {
                        try {
                            withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}", role: "${IAM_ROLE_ARN}", roleAccount: "developer", externalId: 'externalId') {

                                echo "--- Logging in to ECR ---"
                                sh "aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ECR_REPO_URI}"

                                echo "--- Building Docker Image ---"
                                sh "docker build -t ${ECR_NAME} ."

                                echo "--- Pushing Image to ECR ---"
                                sh "docker tag ${ECR_NAME}:latest ${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"
                                sh "docker push ${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"

                                // latest 태그도 갱신 (선택사항)
                                sh "docker tag ${ECR_NAME}:latest ${ECR_REPO_URI}/${ECR_NAME}:latest"
                                sh "docker push ${ECR_REPO_URI}/${ECR_NAME}:latest"

                                sh "docker rmi ${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"
                                sh "docker rmi ${ECR_REPO_URI}/${ECR_NAME}:latest"
                            }
                        } catch (error) {
                            echo "Build Failed: ${error}"
                            currentBuild.result = 'FAILURE'
                            throw error
                        }
                    }
                }
            }
        }


        stage('Deploy to ECS') {
            steps {
                script {
                    dir("${PROJECT_DIR}") { // 디렉토리 위치 확인
                        try {
                            withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}", role: "${IAM_ROLE_ARN}", roleAccount: "developer", externalId: 'externalId') {

                                echo "--- 1. Fetch Current Task Definition ---"
                                // AWS에서 현재 설정을 가져와 파일로 저장
                                sh "aws ecs describe-task-definition --task-definition ${ECS_TASK_FAMILY} --region ${REGION} > current_task_def.json"

                                echo "--- 2. Modify JSON using Groovy (Safe Mode) ---"

                                // 파일 읽기
                                def currentJson = readFile(file: 'current_task_def.json')

                                // [핵심 수정] JsonSlurper -> JsonSlurperClassic 으로 변경 (직렬화 오류 해결)
                                def data = new groovy.json.JsonSlurperClassic().parseText(currentJson)

                                // taskDefinition 키가 있으면 그 안으로 진입, 없으면 그대로 사용
                                def taskDef = data.taskDefinition ? data.taskDefinition : data

                                // 불필요한 필드 제거
                                def keysToRemove = ['taskDefinitionArn', 'revision', 'status', 'requiresAttributes', 'compatibilities', 'registeredAt', 'registeredBy']
                                keysToRemove.each { key ->
                                    taskDef.remove(key)
                                }

                                // 이미지 태그 업데이트
                                def newImage = "${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"
                                taskDef.containerDefinitions.each { container ->
                                    if (container.image.contains(ECR_REPO_URI)) {
                                        container.image = newImage
                                        echo "Updated container '${container.name}' image to: ${newImage}"
                                    }
                                }

                                // 수정된 내용을 파일로 저장
                                def newJsonString = groovy.json.JsonOutput.toJson(taskDef)
                                writeFile(file: 'new_task_def.json', text: newJsonString)

                                echo "--- 3. Register New Task Definition ---"

                                // 등록 수행 및 결과 저장
                                sh "aws ecs register-task-definition --cli-input-json file://new_task_def.json --region ${REGION} > register_result.json"

                                // [핵심 수정] 결과 읽기에서도 JsonSlurperClassic 사용
                                def registerResult = readFile(file: 'register_result.json')
                                def resultData = new groovy.json.JsonSlurperClassic().parseText(registerResult)
                                def task_rev = resultData.taskDefinition.revision

                                echo "NEW REVISION: ${task_rev}"

                                echo "--- 4. Update Service ---"
                                sh """
                                    aws ecs update-service \
                                    --cluster ${ECS_CLUSTER} \
                                    --service ${ECS_SERVICE} \
                                    --task-definition ${ECS_TASK_FAMILY}:${task_rev} \
                                    --force-new-deployment \
                                    --region ${REGION}
                                """
                            }
                        } catch (error) {
                            echo "Deploy Failed: ${error}"
                            currentBuild.result = 'FAILURE'
                            throw error
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            slackSend (
                color: '#00FF00',
                message: "SUCCESS: ${env.JOB_NAME} [${env.BUILD_NUMBER}] Deployed"
            )
        }
        failure {
            slackSend (
                color: '#FF0000',
                message: "FAIL: ${env.JOB_NAME} [${env.BUILD_NUMBER}] Check Logs"
            )
        }
    }
}