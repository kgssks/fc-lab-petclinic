pipeline {
    agent any

    environment {
        // =================================================================
        // [수정 필요] 경로를 반드시 확인 후 변경하세요!
        // =================================================================
        // 예: 리포지토리 구조가 app/front-web/Dockerfile 이라면 "app/front-web" 입력
        PROJECT_DIR    = "frontend"

        TASK_JSON_FILE = "task-front-def.json"

        // 프로젝트 설정
        GIT_REPO       = "https://github.com/kgssks/fc-lab-petclinic.git"
        REGION         = "ap-northeast-2"
        ECR_REPO_URI   = "471112978667.dkr.ecr.ap-northeast-2.amazonaws.com"
        ECR_NAME       = "fc-front"
        ECS_CLUSTER    = "final-cluster"
        ECS_SERVICE    = "task-front-def-service"
        ECS_TASK_FAMILY = "task-front-def"

        // 권한 설정
        AWS_CREDENTIALS = "aws-credentials-cicd"
        IAM_ROLE_ARN    = "arn:aws:iam::471112978667:role/ecr-upload-role"
        SLACK_CHANNEL   = "fc-cicd-study"
    }

    stages {
        stage('Git Clone') {
            steps {
                cleanWs()
                git branch: 'main', url: "${GIT_REPO}"
            }
        }

        stage('Build & Push to ECR') {
            steps {
                script {
                    // 디버깅: 실제로 이동하기 전에 파일이 있는지 확인
                    sh "echo Checking directory: ${PROJECT_DIR}"
                    sh "ls -F ${PROJECT_DIR}"

                    dir("${PROJECT_DIR}") {
                        try {
                            withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}", role: "${IAM_ROLE_ARN}", roleAccount: "developer", externalId: 'externalId') {

                                echo "--- Logging in to ECR ---"
                                sh "aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ECR_REPO_URI}"

                                echo "--- Building Docker Image ---"
                                // Dockerfile이 현재 폴더(.)에 있어야 함
                                sh "docker build -t ${ECR_NAME} ."

                                echo "--- Pushing Image to ECR ---"
                                sh "docker tag ${ECR_NAME}:latest ${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"
                                sh "docker push ${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"

                                // latest 태그 갱신
                                sh "docker tag ${ECR_NAME}:latest ${ECR_REPO_URI}/${ECR_NAME}:latest"
                                sh "docker push ${ECR_REPO_URI}/${ECR_NAME}:latest"

                                sh "docker rmi ${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"
                                sh "docker rmi ${ECR_REPO_URI}/${ECR_NAME}:latest"
                            }
                        } catch (error) {
                            echo "Build Failed. Check if Dockerfile exists in ${PROJECT_DIR}"
                            currentBuild.result = 'FAILURE'
                            throw error
                        }
                    }
                }
            }
        }

        stage('Deploy to ECS') {
            steps {
                script {
                    dir("${PROJECT_DIR}") {
                        try {
                            withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}", role: "${IAM_ROLE_ARN}", roleAccount: "developer", externalId: 'externalId') {

                                echo "--- Updating Task Definition ---"
                                // JSON 파일 내의 태그 교체 (:latest -> :BUILD_NUMBER)
                                sh "sed -i 's|${ECR_NAME}:latest|${ECR_NAME}:${BUILD_NUMBER}|g' ${TASK_JSON_FILE}"
                                // 혹시 :0 으로 되어있을 경우를 대비해 추가
                                sh "sed -i 's|${ECR_NAME}:0|${ECR_NAME}:${BUILD_NUMBER}|g' ${TASK_JSON_FILE}"

                                echo "--- Registering Task Definition ---"
                                def task_rev = sh(script: "aws ecs register-task-definition --cli-input-json file://${TASK_JSON_FILE} --region ${REGION} | jq --raw-output .taskDefinition.revision", returnStdout: true).trim()

                                echo "--- Updating Service ---"
                                sh """
                                    aws ecs update-service \
                                    --cluster ${ECS_CLUSTER} \
                                    --service ${ECS_SERVICE} \
                                    --task-definition ${ECS_TASK_FAMILY}:${task_rev} \
                                    --force-new-deployment \
                                    --region ${REGION}
                                """
                            }
                        } catch (error) {
                            echo "Deploy Failed: ${error}"
                            currentBuild.result = 'FAILURE'
                            throw error
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            // Slack 설정 단순화 (시스템 설정 사용)
            slackSend (
                channel: "${SLACK_CHANNEL}",
                color: '#00FF00',
                message: "SUCCESS: ${env.JOB_NAME} [${env.BUILD_NUMBER}] Deployed"
            )
        }
        failure {
            slackSend (
                channel: "${SLACK_CHANNEL}",
                color: '#FF0000',
                message: "FAIL: ${env.JOB_NAME} [${env.BUILD_NUMBER}] Check Jenkins Logs"
            )
        }
    }
}