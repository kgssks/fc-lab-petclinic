pipeline {
    agent any

    environment {
        // =================================================================
        // [수정 필요] 프로젝트 및 AWS 환경 설정
        // =================================================================
        GIT_REPO       = "https://github.com/kgssks/fc-lab-petclinic.git"
        REGION         = "ap-northeast-2"

        // 1. ECR 설정
        ECR_REPO_URI   = "471112978667.dkr.ecr.ap-northeast-2.amazonaws.com" // ECR 주소 (URI)
        ECR_NAME       = "fc-front"      // ECR 리포지토리 이름 (예: front-web 또는 react-front)

        // 2. ECS 설정
        ECS_CLUSTER    = "final-cluster"  // 클러스터 이름
        ECS_SERVICE    = "task-front-def-service" // 배포할 서비스 이름 (질문하신 이름)
        ECS_TASK_FAMILY = "task-front-def" // Task Definition 패밀리 이름 (JSON 파일의 family 값)

        // 3. 파일 경로 설정 (매우 중요!)
        // Dockerfile과 task_definition.json 파일이 있는 폴더 경로를 지정하세요.
        // 예: 리포지토리 루트라면 "." , 하위 폴더면 "app/frontend" 등
        PROJECT_DIR    = "app/frontend"
        TASK_JSON_FILE = "task-front-def.json" // 해당 폴더 내의 JSON 파일명

        // 4. 권한 및 알림 설정
        AWS_CREDENTIALS = "aws-credentials-cicd" // Jenkins에 저장된 AWS 자격증명 ID
        IAM_ROLE_ARN    = "arn:aws:iam::471112978667:role/ecr-upload-role" // Jenkins가 사용할 Role ARN
        SLACK_CHANNEL   = "fc-cicd-study" // 슬랙 채널
    }

    stages {
        // 1. 소스 코드 다운로드
        stage('Git Clone') {
            steps {
                // 워크스페이스를 깨끗하게 비우고 시작 (오류 방지)
                cleanWs()
                git branch: 'main', url: "${GIT_REPO}"
            }
        }

        // 2. Docker 이미지 빌드 및 ECR 업로드
        stage('Build & Push to ECR') {
            steps {
                script {
                    dir("${PROJECT_DIR}") { // 작업 디렉토리 이동
                        try {
                            withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}", role: "${IAM_ROLE_ARN}", roleAccount: "developer", externalId: 'externalId') {

                                echo "--- Logging in to ECR ---"
                                sh "aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ECR_REPO_URI}"

                                echo "--- Building Docker Image ---"
                                // ECR 리포지토리 이름과 빌드 번호를 태그로 사용
                                sh "docker build -t ${ECR_NAME} ."

                                echo "--- Pushing Image to ECR ---"
                                // 빌드 번호 태그 푸시
                                sh "docker tag ${ECR_NAME}:latest ${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"
                                sh "docker push ${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"

                                // (선택) latest 태그도 갱신
                                sh "docker tag ${ECR_NAME}:latest ${ECR_REPO_URI}/${ECR_NAME}:latest"
                                sh "docker push ${ECR_REPO_URI}/${ECR_NAME}:latest"

                                // 로컬 이미지 정리 (디스크 공간 확보)
                                sh "docker rmi ${ECR_REPO_URI}/${ECR_NAME}:${BUILD_NUMBER}"
                                sh "docker rmi ${ECR_REPO_URI}/${ECR_NAME}:latest"
                            }
                        } catch (error) {
                            echo "Build/Push failed: ${error}"
                            currentBuild.result = 'FAILURE'
                            throw error
                        }
                    }
                }
            }
        }

        // 3. ECS 서비스 업데이트 (배포)
        stage('Deploy to ECS') {
            steps {
                script {
                    dir("${PROJECT_DIR}") {
                        try {
                            withAWS(region: "${REGION}", credentials: "${AWS_CREDENTIALS}", role: "${IAM_ROLE_ARN}", roleAccount: "developer", externalId: 'externalId') {

                                echo "--- Updating Task Definition ---"
                                // JSON 파일 내의 이미지 태그를 현재 빌드 번호로 변경 (sed 사용)
                                // 주의: JSON 파일 안에 "image": "..../repo-name:0" 처럼 되어 있어야 함 (0 부분을 치환)
                                // 혹은 "image": "..../repo-name:latest" 라면 latest를 치환
                                sh "sed -i 's|${ECR_NAME}:latest|${ECR_NAME}:${BUILD_NUMBER}|g' ${TASK_JSON_FILE}"
                                // 만약 JSON에 :0 으로 되어 있다면 아래 주석 해제하여 사용
                                // sh "sed -i 's|${ECR_NAME}:0|${ECR_NAME}:${BUILD_NUMBER}|g' ${TASK_JSON_FILE}"

                                echo "--- Registering New Task Revision ---"
                                // 수정된 JSON으로 새로운 Task Definition 등록 후 리비전 번호 추출
                                def task_rev = sh(script: "aws ecs register-task-definition --cli-input-json file://${TASK_JSON_FILE} --region ${REGION} | jq --raw-output .taskDefinition.revision", returnStdout: true).trim()

                                echo "--- Updating Service: ${ECS_SERVICE} to revision ${task_rev} ---"
                                // 서비스 업데이트 (강제 배포)
                                sh """
                                    aws ecs update-service \
                                    --cluster ${ECS_CLUSTER} \
                                    --service ${ECS_SERVICE} \
                                    --task-definition ${ECS_TASK_FAMILY}:${task_rev} \
                                    --force-new-deployment \
                                    --region ${REGION}
                                """

                                echo "--- Waiting for Deployment to Stabilize ---"
                                // 배포 완료 대기 (선택 사항, 배포 속도를 위해 제거 가능)
                                sh "aws ecs wait services-stable --cluster ${ECS_CLUSTER} --services ${ECS_SERVICE} --region ${REGION}"
                            }
                        } catch (error) {
                            echo "Deployment failed: ${error}"
                            currentBuild.result = 'FAILURE'
                            throw error
                        }
                    }
                }
            }
        }
    }

    // 4. 결과 알림
    post {
        success {
            slackSend (
                channel: "${SLACK_CHANNEL}",
                color: '#00FF00',
                message: "SUCCESS: ${env.JOB_NAME} [${env.BUILD_NUMBER}] Deployed to ${ECS_SERVICE}"
            )
        }
        failure {
            slackSend (
                channel: "${SLACK_CHANNEL}",
                color: '#FF0000',
                message: "FAIL: ${env.JOB_NAME} [${env.BUILD_NUMBER}] Deployment Failed"
            )
        }
    }
}